<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>

<script type='text/javascript'>
	console.log('the number of products is ' + '<%= @products.count %>');
</script>

<h2> Products in the market </h2>

<a href="#" data-hide-element='chart'>Chart</a>

<div id="highChartContainer" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>

<table>
	<tbody>
		<tr>
			<th>ID</th>
			<th>Item</th>
			<th>Cost</th>
			<th>Seller</th>
		</tr>

		<% @products.each do |product| %>
			<tr>
				<td><%= product.id %></td>
				<td><%= product.name %></td>
				<td data-product='<%= product.id %>'>$<%= product.price %></td>
				<td><%= product.user.name if product.user.present? %></td>
				<td><%= link_to "+", product_path(product), 
						'data-price' => product.price, 
						'data-incr-price' => product.id, 
						:method           => :put %></td>
			</tr>
		<% end %>
	</tbody>
</table>

<script type='text/javascript'>
	$('[data-incr-price]').on('click', function(e){  // $('[data-incr-price]') is all of the link_to("+") ekements
		e.preventDefault();
		e.stopPropagation();

		url = $(this).attr('href')  // $(this) is the link_to (<a>) that was clicked, 'href' is the attribute of <a>
		console.log('url=' + url);
		price = $(this).attr('data-price');  // $(this) is the link_to (<a>) that was clicked, 'data-price' is the attribute of <a>
		console.log('price=' + price);
		newPrice = parseInt(price) + 1;
		console.log('newPrice=' + newPrice);

		console.log(location.protocol + "//" + location.host + url);
		$.ajax({
				url: url, 
				type: 'put',
				dataType: 'json',
				data: { product: {price: newPrice} }
		}).success(function(data, textStatus, jqXHR) { 
			console.log(data);
			console.log('id is:' + data.id);
			console.log('price is:' + data.price);
			$('[data-product='+ data.id +']').html("$" + data.price);
			$('[data-incr-price='+ data.id +']').attr('data-price', data.price);
		})
	})
</script>

<script type='text/javascript'>

	$('[data-hide-element=chart]').on('click', function(){
			$('#highChartContainer').toggle()
		});

	$(document).ready(function(){
		console.log('start');
		
		chart = new Highcharts.Chart({
			chart: {
					renderTo: 'highChartContainer',
					plotBackgroundColor: null,
					plotBorderWidth: null,
					plotShadow: false
			},
			title: {
					text: 'Browser market shares at a specific website, 2010'
			},
			series: [{
					type: 'pie',
					name: 'Product Share',
					data: <%= @products_map.to_json.html_safe %>
			}]
		});

		console.log(chart);
});
</script>

<%=
		@products.map do |product|
			[product.name, product.price/@sum_price]
		end
%>
